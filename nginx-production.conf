server {
	listen 80;
	listen [::]:80;
	server_name compta;
	server_name compta.canebiere.net;
	root /var/www/compta;
	client_max_body_size 50M;

	gzip on;
	gzip_disable "msie6";
	gzip_vary on;
	gzip_types application/json text/css application/javascript text/javascript application/x-javascript text/xml application/xml application/xml+rss text/plain;
	gzip_proxied any;
	gzip_comp_level 6;
	gzip_buffers 16 8k;
	gzip_http_version 1.0;

	# API Backend (PHP)
	location ~ ^/api/(operations|comptes|tags|import) {
		root /var/www/compta/backend;
		
		# Router toutes les requÃªtes vers le bon fichier PHP
		# /api/operations/balance -> operations.php
		# /api/comptes/1 -> comptes.php
		# /api/tags -> tags.php
		fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
		fastcgi_split_path_info ^(.+\.php)(/.*)$;
		include fastcgi_params;
		fastcgi_param SCRIPT_FILENAME /var/www/compta/backend/api/$1.php;
		fastcgi_param PATH_INFO $fastcgi_path_info if_not_empty;
		fastcgi_param REQUEST_URI $request_uri;
		fastcgi_param DOCUMENT_ROOT /var/www/compta/backend;
	}

	# Frontend React (Production build)
	location / {
		root /var/www/compta/frontend/build;
		try_files $uri $uri/ /index.html;
		
		# Cache static assets
		location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
			expires 1y;
			add_header Cache-Control "public, immutable";
		}
	}

	# Uploads directory
	location /uploads/ {
		alias /var/www/compta/backend/uploads/;
		autoindex off;
	}

	location = /robots.txt {
		auth_basic off;
		allow all;
		log_not_found off;
		access_log off;
	}

	# Deny all attempts to access hidden files
	location ~ /\. {
		deny all;
		access_log off;
		log_not_found off;
	}

	error_log /var/log/nginx/compta/error.log;
	access_log /var/log/nginx/compta/access.log;
}
